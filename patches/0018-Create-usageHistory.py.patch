From b03978a9171476e4005f9745e6d43c6c073f7763 Mon Sep 17 00:00:00 2001
From: abrignoni <abrignoni@gmail.com>
Date: Fri, 15 Jul 2022 19:00:38 -0400
Subject: [PATCH 18/19] Create usageHistory.py

Added parsing for older Android usagestats.
---
 scripts/artifacts/usageHistory.py | 54 +++++++++++++++++++++++++++++++
 1 file changed, 54 insertions(+)
 create mode 100644 scripts/artifacts/usageHistory.py

diff --git a/scripts/artifacts/usageHistory.py b/scripts/artifacts/usageHistory.py
new file mode 100644
index 0000000..2830755
--- /dev/null
+++ b/scripts/artifacts/usageHistory.py
@@ -0,0 +1,54 @@
+import xml.etree.ElementTree as ET  
+import datetime
+
+from scripts.artifact_report import ArtifactHtmlReport
+from scripts.ilapfuncs import timeline, tsv, is_platform_windows, open_sqlite_db_readonly
+
+
+def get_usageHistory(files_found, report_folder, seeker, wrap_text):
+
+    for file_found in files_found:
+        file_found = str(file_found)
+
+        if file_found.endswith('usage-history.xml'):
+            break
+
+    data_list = []
+
+    tree = ET.parse(file_found)
+    root = tree.getroot()
+
+    for elem in root:
+        for subelem in elem:
+            pkg = elem.attrib['name']
+            subitem = subelem.attrib['name']
+            time = subelem.attrib['lrt']
+            if time != ' ':
+                time = int(time)
+                time = datetime.datetime.fromtimestamp(time/1000)
+            data_list.append((time, pkg, subitem))
+
+    if len(data_list) > 0:
+
+        description = 'Usage History'
+        report = ArtifactHtmlReport('Usage History')
+        report.start_artifact_report(report_folder, 'Usage History', description)
+        report.add_script()
+        data_headers = ('Timestamp', 'Package', 'Subitem', )
+        report.write_artifact_data_table(data_headers, data_list, file_found)
+        report.end_artifact_report()
+
+        tsvname = 'Usage History'
+        tsv(report_folder, data_headers, data_list, tsvname)
+
+        tlactivity = 'Usage History'
+        timeline(report_folder, tlactivity, data_list, data_headers)
+    else:
+        logfunc('Usage History data available')
+
+__artifacts__ = {
+        "Usagehistory": (
+                "App Interaction",
+                ('*/usage-history.xml'),
+                get_usageHistory)
+}
\ No newline at end of file
-- 
2.34.1

